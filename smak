#!/bin/bash
# Smak - Makefile parser and build tool
# Bash wrapper scrip

script=$(basename $0)
exe=$0
link=$(readlink $exe)

SCRIPT_DIR="$(dirname $exe)"

case $SCRIPT_DIR in
    .)   SCRIPT_DIR=$PWD ;;
    ./*) SCRIPT_DIR=$PWD${SCRIPT_DIR/./} ;;
esac

# Find the directory where this script is located
while [ ! -z "$link" ]  ; do
    exe=$link
    case $exe in
	*/*) SCRIPT_DIR="$(dirname $exe)" ;;
    esac
    link=$(readlink $exe)
    if [ -z "$link" ] ; then
	break
    fi
done

while true ; do
    case $1 in
      	-KE) shift ; source $1 ; shift ;;
	*)   break ;;
    esac
done

if [ ${PATH/:*/} != "$PWD" ] ; then
    PATH=${PWD}:${PATH}
fi

# Pass the invocation name to smak.pl via environment variable
# Use basename so $(MAKE) is set to "smak" not the full path
export SMAK_INVOKED_AS="$0"

# Set launcher path for bug reports
export SMAK_LAUNCHER="$SCRIPT_DIR/$script"

export PERLLIB="$SCRIPT_DIR"

while [ 0 != $# ] ; do
    case "$1" in
	-cd)     shift
		 cd $1
	         if [ 0 != $? ] ; then exit 1 ; fi
		 shift ;;
	-attach) script=${script}$1 ; shift ;;
	*)       break ;;
    esac
done
# Translate GNU Make-style compact options to Perl-friendly long form
# E.g., "-j4" -> "-j 4"
declare -a perl_args
for arg in "$@"; do
    # Check if argument matches -jN pattern (where N is a number)
    if [[ "$arg" =~ ^-j([0-9]+)$ ]]; then
        # Split into "-j" and the number
        perl_args+=("-j" "${BASH_REMATCH[1]}")
    else
        # Pass through as-is
        perl_args+=("$arg")
    fi
done

# Execute the Perl script with translated arguments
exec perl ${SMAK_PERL_DEBUG} "$SCRIPT_DIR/$script.pl" "${perl_args[@]}"
