#!/bin/bash
# Regression test suite for smak
# Runs all test scripts and reports results

set +e  # Don't exit on error - we want to run all tests

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Parse arguments
FULL_MODE=0
VERBOSE=0
if [ "$1" = "--full" ] || [ "$1" = "-f" ]; then
    FULL_MODE=1
elif [ "$1" = "--verbose" ] || [ "$1" = "-v" ]; then
    VERBOSE=1
elif [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    cat << EOF
Usage: $0 [OPTIONS]

Run smak regression test suite.

Options:
  (none)        Run quick regression tests (non-interactive unit tests)
  -f, --full    Run full test suite including random builds and CLI tests
  -v, --verbose Show test output
  -h, --help    Show this help

Examples:
  $0            # Quick regression (default)
  $0 --full     # Full test suite
  $0 --verbose  # Show all test output

EOF
    exit 0
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
TOTAL=0
PASSED=0
FAILED=0
SKIPPED=0

# Test results
declare -a FAILED_TESTS
declare -a PASSED_TESTS

echo "======================================"
echo "SMAK REGRESSION TEST SUITE"
echo "======================================"
echo ""

# Function to run a test script
run_test() {
    local test_script="$1"
    local test_name=$(basename "$test_script" .sh)

    ((TOTAL++))

    printf "Running %-40s ... " "$test_name"

    if [ ! -x "$test_script" ]; then
        echo -e "${YELLOW}SKIP${NC} (not executable)"
        ((SKIPPED++))
        return
    fi

    # Run test and capture output
    local output
    local start_time=$(date +%s)

    if [ $VERBOSE -eq 1 ]; then
        ./"$test_script"
        local result=$?
    else
        output=$(./"$test_script" 2>&1 < /dev/null)
        local result=$?
    fi

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    if [ $result -eq 0 ]; then
        echo -e "${GREEN}PASS${NC} (${duration}s)"
        ((PASSED++))
        PASSED_TESTS+=("$test_name")
    else
        echo -e "${RED}FAIL${NC} (${duration}s)"
        ((FAILED++))
        FAILED_TESTS+=("$test_name")
        # Save failure output
        if [ $VERBOSE -eq 0 ]; then
            echo "$output" > "/tmp/smak-test-fail-$test_name.log"
        fi
    fi
}

# Run all test_*.sh scripts (non-interactive unit tests)
echo "Unit Tests:"
echo "----------"
for test in test_*.sh; do
    if [ -f "$test" ]; then
        run_test "$test"
    fi
done

# Run default target test
echo ""
echo "Default Target Tests:"
echo "--------------------"
if [ -f "test-default-target.sh" ]; then
    run_test "test-default-target.sh"
fi

# Run generator-based tests if in full mode
if [ $FULL_MODE -eq 1 ]; then
    echo ""
    echo "Random Build Tests:"
    echo "------------------"
    echo "(Running 10 iterations, may take 1-2 minutes...)"

    if [ -x "./run-tests" ]; then
        # Run test-generator tests
        if [ $VERBOSE -eq 1 ]; then
            ./run-tests -f 5 -t 60 -v
            local gen_result=$?
        else
            ./run-tests -f 5 -t 60 > /tmp/smak-generator-test.log 2>&1
            local gen_result=$?
        fi

        if [ $gen_result -eq 0 ]; then
            echo -e "Random builds:                            ${GREEN}PASS${NC}"
            ((PASSED++))
            ((TOTAL++))
        else
            echo -e "Random builds:                            ${RED}FAIL${NC}"
            ((FAILED++))
            ((TOTAL++))
            FAILED_TESTS+=("random-builds")
        fi
    else
        echo -e "run-tests not found:                      ${YELLOW}SKIP${NC}"
        ((SKIPPED++))
        ((TOTAL++))
    fi
fi

# Run CLI tests if in full mode
if [ $FULL_MODE -eq 1 ]; then
    echo ""
    echo "CLI Tests:"
    echo "---------"

    if [ -x "./test-cli-advanced" ]; then
        if [ $VERBOSE -eq 1 ]; then
            ./test-cli-advanced
            local cli_result=$?
        else
            ./test-cli-advanced > /tmp/smak-cli-test.log 2>&1
            local cli_result=$?
        fi

        if [ $cli_result -eq 0 ]; then
            echo -e "Advanced CLI tests:                       ${GREEN}PASS${NC}"
            ((PASSED++))
            ((TOTAL++))
        else
            echo -e "Advanced CLI tests:                       ${RED}FAIL${NC}"
            ((FAILED++))
            ((TOTAL++))
            FAILED_TESTS+=("cli-tests")
        fi
    else
        echo -e "test-cli-advanced not found:              ${YELLOW}SKIP${NC}"
        ((SKIPPED++))
        ((TOTAL++))
    fi
fi

# Summary
echo ""
echo "======================================"
echo "TEST SUMMARY"
echo "======================================"
echo "Total tests:   $TOTAL"
echo -e "Passed:        ${GREEN}$PASSED${NC}"
echo -e "Failed:        ${RED}$FAILED${NC}"
echo -e "Skipped:       ${YELLOW}$SKIPPED${NC}"

if [ $FAILED -gt 0 ]; then
    echo ""
    echo "Failed tests:"
    for test in "${FAILED_TESTS[@]}"; do
        echo -e "  ${RED}âœ—${NC} $test"
        if [ -f "/tmp/smak-test-fail-$test.log" ]; then
            echo "     Log: /tmp/smak-test-fail-$test.log"
        fi
    done
    echo ""
    echo "Tip: Run with --verbose to see test output"
fi

echo ""
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All tests passed!${NC}"
    if [ $FULL_MODE -eq 0 ]; then
        echo ""
        echo "Note: This was a quick regression test."
        echo "Run '$0 --full' for comprehensive testing including:"
        echo "  - Random build tests (test-generator)"
        echo "  - CLI interaction tests"
    fi
    exit 0
else
    echo -e "${RED}Some tests failed.${NC}"
    exit 1
fi
