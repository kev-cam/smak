#!/bin/bash
# Regression test suite for smak
# Runs all test scripts and reports results

set +e  # Don't exit on error - we want to run all tests

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Parse arguments
FULL_MODE=0
VERBOSE=0
TTY_MODE=0
if [ "$1" = "--full" ] || [ "$1" = "-f" ]; then
    FULL_MODE=1
elif [ "$1" = "--verbose" ] || [ "$1" = "-v" ]; then
    VERBOSE=1
elif [ "$1" = "--tty" ] || [ "$1" = "-t" ]; then
    TTY_MODE=1
elif [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    cat << EOF
Usage: $0 [OPTIONS]

Run smak regression test suite.

By default, all tests including interactive ones are run automatically.
Interactive tests use script files (scripts/*.script) for automation.

All tests are run twice - once with cache disabled and once with cache enabled.
This ensures consistent behavior between cached and non-cached execution.

Options:
  (none)              Run all tests including scripted interactive tests
  -f, --full          Run full test suite including random builds and CLI tests
  -v, --verbose       Show test output
  -t, --tty           Run interactive tests with actual TTY input (not scripted)
  -h, --help          Show this help

Examples:
  $0                  # All tests with scripted automation (default)
  $0 --full           # Full test suite
  $0 --verbose        # Show all test output
  $0 --tty            # Interactive tests require user input

EOF
    exit 0
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
TOTAL=0
PASSED=0
FAILED=0
SKIPPED=0

# Test results
declare -a FAILED_TESTS
declare -a PASSED_TESTS

echo "======================================"
echo "SMAK REGRESSION TEST SUITE"
echo "======================================"
echo ""

# Function to run a test script
run_test() {
    local test_script="$1"
    local test_name=$(basename "$test_script" .sh)

    ((TOTAL++))

    printf "Running %-40s ... " "$test_name"

    if [ ! -x "$test_script" ]; then
        echo -e "${YELLOW}SKIP${NC} (not executable)"
        ((SKIPPED++))
        return
    fi

    # Check if test uses interactive debug mode (-Kd flag)
    local is_interactive=0
    if grep -q "\-Kd" "$test_script" 2>/dev/null; then
        is_interactive=1
    fi

    # Check if there's a script file for this test
    local script_file="scripts/${test_name}.script"
    local has_script=0
    if [ -f "$script_file" ]; then
        has_script=1
    fi

    # Handle interactive tests:
    # - If --tty mode: run with user input (don't redirect stdin)
    # - If script exists: run with test-cli-advanced automation (TODO)
    # - Otherwise: skip and suggest creating script file
    if [ $is_interactive -eq 1 ] && [ $TTY_MODE -eq 0 ] && [ $has_script -eq 0 ]; then
        echo -e "${YELLOW}SKIP${NC} (interactive, create $script_file or use --tty)"
        ((SKIPPED++))
        return
    fi

    # Run test and capture output
    local output_nocache output_cache
    local start_time=$(date +%s)

    if [ $VERBOSE -eq 1 ]; then
        echo ""
        echo "  [no-cache]"
        SMAK_CACHE_DIR=off ./"$test_script"
        local result_nocache=$?
        echo "  [with-cache]"
        SMAK_CACHE_DIR=default ./"$test_script"
        local result_cache=$?
    else
        # Determine if we need stdin for this test
        # TTY mode: always allow stdin for interactive tests
        # Script mode: interactive tests with scripts don't need stdin (automated)
        # Default: redirect stdin to prevent hangs
        local needs_stdin=0
        if [ $is_interactive -eq 1 ] && [ $TTY_MODE -eq 1 ]; then
            needs_stdin=1
        elif [ $is_interactive -eq 1 ] && [ $has_script -eq 1 ]; then
            # TODO: Use test-cli-advanced with script file for automation
            # For now, allow stdin since script will provide it
            needs_stdin=1
        fi

        if [ $needs_stdin -eq 1 ]; then
            # Run with stdin available (TTY mode or scripted interactive)
            output_nocache=$(SMAK_CACHE_DIR=off ./"$test_script" 2>&1)
            local result_nocache=$?

            output_cache=$(SMAK_CACHE_DIR=default ./"$test_script" 2>&1)
            local result_cache=$?
        else
            # Run without stdin (prevents hangs for non-interactive tests)
            output_nocache=$(SMAK_CACHE_DIR=off ./"$test_script" 2>&1 < /dev/null)
            local result_nocache=$?

            output_cache=$(SMAK_CACHE_DIR=default ./"$test_script" 2>&1 < /dev/null)
            local result_cache=$?
        fi
    fi

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    # Check if both runs passed
    if [ $result_nocache -eq 0 ] && [ $result_cache -eq 0 ]; then
        echo -e "${GREEN}PASS${NC} (${duration}s)"
        ((PASSED++))
        PASSED_TESTS+=("$test_name")
    # Check if cache behavior differs from no-cache
    elif [ $result_nocache -ne $result_cache ]; then
        echo -e "${RED}FAIL${NC} (cache mismatch: no-cache=$result_nocache, cache=$result_cache)"
        ((FAILED++))
        FAILED_TESTS+=("$test_name")
        # Save both outputs for comparison
        if [ $VERBOSE -eq 0 ]; then
            echo "=== NO CACHE ===" > "/tmp/smak-test-fail-$test_name.log"
            echo "$output_nocache" >> "/tmp/smak-test-fail-$test_name.log"
            echo "" >> "/tmp/smak-test-fail-$test_name.log"
            echo "=== WITH CACHE ===" >> "/tmp/smak-test-fail-$test_name.log"
            echo "$output_cache" >> "/tmp/smak-test-fail-$test_name.log"
        fi
    else
        # Both failed with same result
        echo -e "${RED}FAIL${NC} (${duration}s)"
        ((FAILED++))
        FAILED_TESTS+=("$test_name")
        # Save failure output (no-cache version)
        if [ $VERBOSE -eq 0 ]; then
            echo "$output_nocache" > "/tmp/smak-test-fail-$test_name.log"
        fi
    fi
}

# Run all test_*.sh scripts (non-interactive unit tests)
echo "Unit Tests:"
echo "----------"
for test in test_*.sh; do
    if [ -f "$test" ]; then
        run_test "$test"
    fi
done

# Run default target test
echo ""
echo "Default Target Tests:"
echo "--------------------"
if [ -f "test-default-target.sh" ]; then
    run_test "test-default-target.sh"
fi

# Run generator-based tests if in full mode
if [ $FULL_MODE -eq 1 ]; then
    echo ""
    echo "Random Build Tests:"
    echo "------------------"
    echo "(Running 10 iterations, may take 1-2 minutes...)"

    if [ -x "./run-tests" ]; then
        # Run test-generator tests
        if [ $VERBOSE -eq 1 ]; then
            ./run-tests -f 5 -t 60 -v
            local gen_result=$?
        else
            ./run-tests -f 5 -t 60 > /tmp/smak-generator-test.log 2>&1
            local gen_result=$?
        fi

        if [ $gen_result -eq 0 ]; then
            echo -e "Random builds:                            ${GREEN}PASS${NC}"
            ((PASSED++))
            ((TOTAL++))
        else
            echo -e "Random builds:                            ${RED}FAIL${NC}"
            ((FAILED++))
            ((TOTAL++))
            FAILED_TESTS+=("random-builds")
        fi
    else
        echo -e "run-tests not found:                      ${YELLOW}SKIP${NC}"
        ((SKIPPED++))
        ((TOTAL++))
    fi
fi

# Run CLI tests if in full mode
if [ $FULL_MODE -eq 1 ]; then
    echo ""
    echo "CLI Tests:"
    echo "---------"

    if [ -x "./test-cli-advanced" ]; then
        if [ $VERBOSE -eq 1 ]; then
            ./test-cli-advanced
            local cli_result=$?
        else
            ./test-cli-advanced > /tmp/smak-cli-test.log 2>&1
            local cli_result=$?
        fi

        if [ $cli_result -eq 0 ]; then
            echo -e "Advanced CLI tests:                       ${GREEN}PASS${NC}"
            ((PASSED++))
            ((TOTAL++))
        else
            echo -e "Advanced CLI tests:                       ${RED}FAIL${NC}"
            ((FAILED++))
            ((TOTAL++))
            FAILED_TESTS+=("cli-tests")
        fi
    else
        echo -e "test-cli-advanced not found:              ${YELLOW}SKIP${NC}"
        ((SKIPPED++))
        ((TOTAL++))
    fi
fi

# Summary
echo ""
echo "======================================"
echo "TEST SUMMARY"
echo "======================================"
echo "Total tests:   $TOTAL"
echo -e "Passed:        ${GREEN}$PASSED${NC}"
echo -e "Failed:        ${RED}$FAILED${NC}"
echo -e "Skipped:       ${YELLOW}$SKIPPED${NC}"

if [ $FAILED -gt 0 ]; then
    echo ""
    echo "Failed tests:"
    for test in "${FAILED_TESTS[@]}"; do
        echo -e "  ${RED}âœ—${NC} $test"
        if [ -f "/tmp/smak-test-fail-$test.log" ]; then
            echo "     Log: /tmp/smak-test-fail-$test.log"
        fi
    done
    echo ""
    echo "Tip: Run with --verbose to see test output"
fi

echo ""
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All tests passed!${NC}"
    if [ $FULL_MODE -eq 0 ]; then
        echo ""
        echo "Note: This was a quick regression test."
        echo "Run '$0 --full' for comprehensive testing including:"
        echo "  - Random build tests (test-generator)"
        echo "  - CLI interaction tests"
    fi
    exit 0
else
    echo -e "${RED}Some tests failed.${NC}"
    exit 1
fi
