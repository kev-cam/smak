#!/bin/bash
# Test a specific git revision
# Usage: ./test-revision [commit-hash]
#        If no hash provided, shows menu to select from recent commits

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$REPO_ROOT"

# If a commit hash is provided, use it
if [ -n "$1" ]; then
    COMMIT="$1"
else
    # Show recent commits and let user pick
    echo "Recent commits on current branch:"
    echo "=================================="
    git log --oneline --decorate -20
    echo ""
    echo -n "Enter commit hash (or press Enter for HEAD): "
    read COMMIT

    if [ -z "$COMMIT" ]; then
        COMMIT="HEAD"
    fi
fi

# Validate commit exists
if ! git rev-parse "$COMMIT" >/dev/null 2>&1; then
    echo "Error: Invalid commit '$COMMIT'"
    exit 1
fi

# Get commit short hash for directory name
COMMIT_SHORT=$(git rev-parse --short "$COMMIT")
TAG=$(date +%Y%m%d-%H%M%S)
TEST_DIR="/tmp/smak/test-${TAG}-${COMMIT_SHORT}"

echo ""
echo "Testing commit: $(git log -1 --oneline "$COMMIT")"
echo "Test directory: $TEST_DIR"
echo ""

# Create test directory and clone
echo "Cloning repository to test directory..."
mkdir -p "$TEST_DIR"
git clone -q "$REPO_ROOT" "$TEST_DIR"

# Checkout the target commit in the cloned directory
echo "Checking out $COMMIT in clone..."
cd "$TEST_DIR"
git checkout -q "$COMMIT"

# Run tests
echo ""
echo "Running regression tests..."
echo "============================"
cd test
if ./run-regression; then
    TEST_RESULT="PASSED"
    TEST_EXIT=0
else
    TEST_RESULT="FAILED"
    TEST_EXIT=1
fi

# Print summary
echo ""
echo "============================"
echo "Test Summary"
echo "============================"
echo "Commit:  $(git log -1 --oneline "$COMMIT")"
echo "Result:  $TEST_RESULT"
echo ""
echo "Test directory preserved at: $TEST_DIR"
echo "============================"
echo ""

exit $TEST_EXIT
