#!/bin/bash
# Regression test suite for smak
# Runs all test scripts and reports results

set +e  # Don't exit on error - we want to run all tests

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
TOTAL=0
PASSED=0
FAILED=0
SKIPPED=0

# Test results
declare -a FAILED_TESTS
declare -a PASSED_TESTS

echo "======================================"
echo "SMAK REGRESSION TEST SUITE"
echo "======================================"
echo ""

# Function to run a test script
run_test() {
    local test_script="$1"
    local test_name=$(basename "$test_script" .sh)

    ((TOTAL++))

    printf "Running %-40s ... " "$test_name"

    if [ ! -x "$test_script" ]; then
        echo -e "${YELLOW}SKIP${NC} (not executable)"
        ((SKIPPED++))
        return
    fi

    # Run test and capture output
    local output
    output=$(./"$test_script" 2>&1)
    local result=$?

    if [ $result -eq 0 ]; then
        echo -e "${GREEN}PASS${NC}"
        ((PASSED++))
        PASSED_TESTS+=("$test_name")
    else
        echo -e "${RED}FAIL${NC}"
        ((FAILED++))
        FAILED_TESTS+=("$test_name")
        # Save failure output
        echo "$output" > "/tmp/smak-test-fail-$test_name.log"
    fi
}

# Run all test_*.sh scripts
echo "Unit Tests:"
echo "----------"
for test in test_*.sh; do
    if [ -f "$test" ]; then
        run_test "$test"
    fi
done

# Run default target test
echo ""
echo "Default Target Tests:"
echo "--------------------"
if [ -f "test-default-target.sh" ]; then
    run_test "test-default-target.sh"
fi

# Run generator-based tests if requested
if [ "$1" = "--full" ] || [ "$1" = "-f" ]; then
    echo ""
    echo "Random Build Tests:"
    echo "------------------"
    echo "(Running 10 iterations...)"

    if [ -x "./run-tests" ]; then
        # Run test-generator tests
        ./run-tests -f 5 -t 60 -v > /tmp/smak-generator-test.log 2>&1
        if [ $? -eq 0 ]; then
            echo -e "Random builds:                            ${GREEN}PASS${NC}"
            ((PASSED++))
            ((TOTAL++))
        else
            echo -e "Random builds:                            ${RED}FAIL${NC}"
            ((FAILED++))
            ((TOTAL++))
            FAILED_TESTS+=("random-builds")
        fi
    fi
fi

# Run CLI tests if requested
if [ "$1" = "--full" ] || [ "$1" = "-f" ]; then
    echo ""
    echo "CLI Tests:"
    echo "---------"

    if [ -x "./test-cli-advanced" ]; then
        ./test-cli-advanced > /tmp/smak-cli-test.log 2>&1
        if [ $? -eq 0 ]; then
            echo -e "Advanced CLI tests:                       ${GREEN}PASS${NC}"
            ((PASSED++))
            ((TOTAL++))
        else
            echo -e "Advanced CLI tests:                       ${RED}FAIL${NC}"
            ((FAILED++))
            ((TOTAL++))
            FAILED_TESTS+=("cli-tests")
        fi
    fi
fi

# Summary
echo ""
echo "======================================"
echo "TEST SUMMARY"
echo "======================================"
echo "Total tests:   $TOTAL"
echo -e "Passed:        ${GREEN}$PASSED${NC}"
echo -e "Failed:        ${RED}$FAILED${NC}"
echo -e "Skipped:       ${YELLOW}$SKIPPED${NC}"

if [ $FAILED -gt 0 ]; then
    echo ""
    echo "Failed tests:"
    for test in "${FAILED_TESTS[@]}"; do
        echo -e "  ${RED}âœ—${NC} $test"
        if [ -f "/tmp/smak-test-fail-$test.log" ]; then
            echo "     Log: /tmp/smak-test-fail-$test.log"
        fi
    done
fi

echo ""
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All tests passed!${NC}"
    exit 0
else
    echo -e "${RED}Some tests failed.${NC}"
    exit 1
fi
