#!/usr/bin/perl
use strict;
use warnings;
use IO::Socket::INET;
use POSIX qw(:sys_wait_h);

# Usage: smak-worker <host:port>
my $server_addr = $ARGV[0] or die "Usage: $0 <host:port>\n";

# Parse host:port
my ($host, $port) = split(/:/, $server_addr);
die "Invalid address format. Use host:port\n" unless defined $port;

# Connect to master
print STDERR "Worker connecting to $host:$port...\n";
my $socket = IO::Socket::INET->new(
    PeerHost => $host,
    PeerPort => $port,
    Proto    => 'tcp',
    Timeout  => 10,
) or die "Cannot connect to master at $host:$port: $!\n";

$socket->autoflush(1);
print STDERR "Worker connected to master\n";

# Send ready signal
print $socket "READY\n";

# Receive environment
my $env_done = 0;
while (my $line = <$socket>) {
    chomp $line;

    if ($line eq 'ENV_START') {
        next;
    } elsif ($line eq 'ENV_END') {
        $env_done = 1;
        print STDERR "Worker received environment\n";
        last;
    } elsif ($line =~ /^ENV (\w+)=(.*)$/) {
        # Set environment variable
        $ENV{$1} = $2;
    } else {
        die "Unexpected line during environment setup: $line\n";
    }
}

die "Connection closed before environment received\n" unless $env_done;

# Main loop: receive and execute commands
while (my $line = <$socket>) {
    chomp $line;

    # Check for shutdown signal
    if ($line eq 'SHUTDOWN') {
        print STDERR "Worker shutting down on master request\n";
        last;
    }

    # Parse command format: "task <#> ; cd <dir> ; <command>"
    # Or simplified: "TASK <#>\nDIR <dir>\nCMD <command>\n"
    if ($line =~ /^TASK (\d+)$/) {
        my $task_id = $1;

        # Get directory
        my $dir_line = <$socket>;
        chomp $dir_line;
        die "Expected DIR line, got: $dir_line\n" unless $dir_line =~ /^DIR (.*)$/;
        my $dir = $1;

        # Get command
        my $cmd_line = <$socket>;
        chomp $cmd_line;
        die "Expected CMD line, got: $cmd_line\n" unless $cmd_line =~ /^CMD (.*)$/;
        my $command = $1;

        # Execute command
        print STDERR "Worker executing task $task_id: $command\n";

        # Change to directory
        my $old_dir = `pwd`;
        chomp $old_dir;
        chdir($dir) or do {
            # Send error back
            print $socket "TASK_START $task_id\n";
            print $socket "OUTPUT ERROR: Cannot chdir to $dir: $!\n";
            print $socket "TASK_END $task_id 1\n";
            print $socket "READY\n";
            next;
        };

        # Signal task start
        print $socket "TASK_START $task_id\n";

        # Execute command and stream output in real-time
        my $exit_code = 0;

        # Use pipe to capture output incrementally
        my $pid = open(my $cmd_fh, '-|', "$command 2>&1");
        if ($pid) {
            # Parent: read output line by line and send immediately
            while (my $line = <$cmd_fh>) {
                chomp $line;
                print $socket "OUTPUT $line\n";
            }
            close($cmd_fh);
            $exit_code = $? >> 8;
        } else {
            # Fork failed
            print $socket "OUTPUT ERROR: Failed to execute command: $!\n";
            $exit_code = 1;
        }

        # Send completion
        print $socket "TASK_END $task_id $exit_code\n";

        # Send ready for next task
        print $socket "READY\n";

        # Restore directory
        chdir($old_dir);
    } else {
        warn "Worker received unexpected command: $line\n";
    }
}

# Connection closed
print STDERR "Worker disconnected from master\n";
close($socket);
exit 0;
